name: OrangeHRM Atomic Pro Execution

on:
  push:
    branches: [ "main", "master" ]
  workflow_dispatch:
    inputs:
      browser:
        description: 'Select Browser'
        default: 'chrome'
        type: choice
        options: [chrome, firefox]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BROWSER: ${{ github.event.inputs.browser || 'chrome' }}
  MAVEN_OPTS: "-Xmx3072m -Djava.awt.headless=true"

jobs:
  # ====================================================
  # 1. Foundation: Seed Data (Single Machine)
  # ====================================================
  foundation:
    name: 1. Foundation Setup
    runs-on: ubuntu-latest
    timeout-minutes: 45
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          export DISPLAY=:99

      - name: Run Foundation
        run: |
          mvn test -B \
            -Dsurefire.suiteXmlFiles=testng.xml \
            -Dtestnames="Foundation_Data_Seeding" \
            -Dgroups="foundation" \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=false

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-foundation
          path: target/allure-results
          retention-days: 1

  # ====================================================
  # 2. Regression Matrix (46 Parallel Shards) âš¡
  # ====================================================
  regression_matrix:
    name: 2. ${{ matrix.shard_name }}
    needs: foundation
    if: success()
    runs-on: ubuntu-latest
    timeout-minutes: 15 # ÙƒÙ„ shard Ø³ÙŠØ£Ø®Ø° Ø¯Ù‚Ø§Ø¦Ù‚ Ù…Ø¹Ø¯ÙˆØ¯Ø© ÙÙ‚Ø·
    strategy:
      fail-fast: false
      matrix:
        shard_name: [
          # Admin
          "Reg_Admin_Job", "Reg_Admin_Org", "Reg_Admin_Qual",
          "Reg_Admin_Config", "Reg_Admin_Nat", "Reg_Admin_Users",
          # PIM
          "Reg_PIM_Config", "Reg_PIM_Emp", "Reg_PIM_Details", "Reg_PIM_Reports",
          # Recruitment
          "Reg_Rec_Vacancies", "Reg_Rec_E2E", "Reg_Rec_Workflow",
          "Reg_Rec_Search", "Reg_Rec_Actions",
          # Leave
          "Reg_Leave_Apply", "Reg_Leave_List", "Reg_Leave_Ops",
          "Reg_Leave_Reports", "Reg_Leave_Config", "Reg_Leave_Entitle",
          # Time
          "Reg_Time_Attend", "Reg_Time_Sheets", "Reg_Time_Project",
          "Reg_Time_Logic", "Reg_Time_Reports", "Reg_Time_Config",
          # Claim
          "Reg_Claim_Adv", "Reg_Claim_Emp", "Reg_Claim_Ops", "Reg_Claim_Config",
          # Performance
          "Reg_Perf_Reviews", "Reg_Perf_MyRev", "Reg_Perf_Eval",
          "Reg_Perf_Reports", "Reg_Perf_Config",
          # Dashboard, Buzz, Directory, Maint
          "Reg_Dash_Widgets", "Reg_Dash_Actions", "Reg_Dash_Adv",
          "Reg_Buzz_Feed", "Reg_Buzz_Feat", "Reg_Directory",
          "Reg_Maint_Auth", "Reg_Maint_Access", "Reg_Maint_Purge", "Reg_Maint_Safety"
        ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          export DISPLAY=:99

      - name: Run ${{ matrix.shard_name }}
        run: |
          mvn test -B \
            -Dsurefire.suiteXmlFiles=testng.xml \
            -Dtestnames="${{ matrix.shard_name }}" \
            -Dgroups="regression" \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ matrix.shard_name }}
          path: target/allure-results
          retention-days: 1

  # ====================================================
  # 3. Cleanup Matrix (8 Parallel Shards) ðŸ§¹
  # ====================================================
  cleanup_matrix:
    name: 3. ${{ matrix.clean_shard }}
    needs: [regression_matrix]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      fail-fast: false
      matrix:
        clean_shard: [
          "Clean_Admin",
          "Clean_PIM",
          "Clean_Recruit",
          "Clean_Time",
          "Clean_Perf",
          "Clean_Claim",
          "Clean_Buzz"
        ]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven
      - name: Setup Xvfb
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb
          Xvfb :99 -screen 0 1920x1080x24 > /dev/null 2>&1 &
          echo "XVFB_PID=$!" >> $GITHUB_ENV
          export DISPLAY=:99

      - name: Run Cleanup
        run: |
          mvn test -B \
            -Dsurefire.suiteXmlFiles=testng.xml \
            -Dtestnames="${{ matrix.clean_shard }}" \
            -Dbrowser=${{ env.BROWSER }} \
            -Dheadless=true \
            -Dmaven.test.failure.ignore=true

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results-${{ matrix.clean_shard }}
          path: target/allure-results
          retention-days: 1

  # ====================================================
  # 4. Final Report
  # ====================================================
  report:
    name: Generate Final Report
    needs: [foundation, regression_matrix, cleanup_matrix]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/download-artifact@v4
        with:
          pattern: allure-results-*
          path: all-results
          merge-multiple: true

      - name: Generate Allure Report
        uses: simple-elf/allure-report-action@master
        if: always()
        with:
          allure_results: all-results
          allure_history: gh-pages
          keep_reports: 30

      - name: Deploy Report
        uses: peaceiris/actions-gh-pages@v3
        if: always()
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: allure-report